version: 2.1

jobs:
  deploy:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      - run:
          name: Install lftp
          command: |
            sudo apt-get update -y
            sudo apt-get install -y lftp

      - run:
          name: Test FTP connectivity
          command: |
            echo "üîç Testing FTP connection to $FTP_SERVER ..."
            lftp -u "$FTP_USERNAME","$FTP_PASSWORD" ftp://"$FTP_SERVER" -e "ls; bye" || (echo "‚ùå FTP connection failed (check FTP_SERVER / FTP_USERNAME / FTP_PASSWORD)" && exit 1)
            echo "‚úÖ FTP reachable."

      - run:
          name: Validate remote theme path
          command: |
            echo "üîç Validating remote path..."
            lftp -u "$FTP_USERNAME","$FTP_PASSWORD" ftp://"$FTP_SERVER" -e "
              set ftp:ssl-allow true;
              set ssl:verify-certificate no;
              cd /maxcyte.devsspace.com/wp-content/themes/bb-theme-child/ || (echo '‚ùå ERROR: Remote theme path not found' && exit 1);
              bye"
            echo "‚úÖ Remote path exists."

      - run:
          name: Deploy bb-theme-child via FTP
          command: |
            echo "‚¨ÜÔ∏è Starting deployment to WP Engine server..."
            lftp -e "
              set ftp:ssl-allow true;
              set ssl:verify-certificate no;
              set net:timeout 20;
              set net:max-retries 2;
              open -u $FTP_USERNAME,$FTP_PASSWORD $FTP_SERVER;
              mirror -R ./bb-theme-child /maxcyte.devsspace.com/wp-content/themes/bb-theme-child --ignore-time --parallel=2 --verbose;
              bye
            "
            echo "‚úÖ Deployment finished."

workflows:
  version: 2
  deploy_on_push:
    jobs:
      - deploy:
          filters:
            branches:
              only: main
